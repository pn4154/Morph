---
# Namespace
apiVersion: v1
kind: Namespace
metadata:
  name: morph
  labels:
    app: morph
---
# Secrets for PostgreSQL
apiVersion: v1
kind: Secret
metadata:
  name: postgres-secrets
  namespace: morph
type: Opaque
stringData:
  password: "MorphSecurePass123!"
  replication-password: "MorphReplication123!"
---
# ConfigMap for PostgreSQL configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-config
  namespace: morph
data:
  postgresql.conf: |
    # Connection settings
    listen_addresses = '*'
    max_connections = 200
    
    # Citus settings
    shared_preload_libraries = 'citus,pg_stat_statements'
    citus.node_conninfo = 'sslmode=prefer'
    
    # Memory settings
    shared_buffers = 256MB
    effective_cache_size = 768MB
    work_mem = 16MB
    maintenance_work_mem = 128MB
    
    # WAL settings
    wal_level = logical
    max_wal_senders = 10
    max_replication_slots = 10
    
    # Query planning
    random_page_cost = 1.1
    effective_io_concurrency = 200
    
    # Logging
    log_statement = 'all'
    log_duration = on
    log_min_duration_statement = 100
    
    # Statistics
    track_io_timing = on
    track_functions = all
    
  pg_hba.conf: |
    # TYPE  DATABASE        USER            ADDRESS                 METHOD
    local   all             all                                     trust
    host    all             all             0.0.0.0/0               trust
    host    all             all             ::/0                    trust
    host    replication     all             0.0.0.0/0               trust
---
# Storage class for persistent volumes
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: morph-storage
provisioner: k8s.io/minikube-hostpath
reclaimPolicy: Delete
volumeBindingMode: Immediate
---
# PVC for Coordinator
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: citus-coordinator-pvc
  namespace: morph
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: morph-storage
  resources:
    requests:
      storage: 10Gi
---
# Headless Service for Coordinator
apiVersion: v1
kind: Service
metadata:
  name: citus-coordinator
  namespace: morph
  labels:
    app: citus-coordinator
spec:
  type: ClusterIP
  ports:
    - port: 5432
      targetPort: 5432
      name: postgres
  selector:
    app: citus-coordinator
---
# Coordinator Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: citus-coordinator
  namespace: morph
  labels:
    app: citus-coordinator
spec:
  replicas: 1
  selector:
    matchLabels:
      app: citus-coordinator
  template:
    metadata:
      labels:
        app: citus-coordinator
        role: coordinator
    spec:
      containers:
        - name: coordinator
          image: citusdata/citus:12.1
          ports:
            - containerPort: 5432
          env:
            - name: POSTGRES_USER
              value: "morph"
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: postgres-secrets
                  key: password
            - name: POSTGRES_DB
              value: "morphdb"
            - name: PGDATA
              value: "/var/lib/postgresql/data/pgdata"
          volumeMounts:
            - name: data
              mountPath: /var/lib/postgresql/data
            - name: config
              mountPath: /etc/postgresql/postgresql.conf
              subPath: postgresql.conf
            - name: config
              mountPath: /etc/postgresql/pg_hba.conf
              subPath: pg_hba.conf
          resources:
            requests:
              memory: "512Mi"
              cpu: "500m"
            limits:
              memory: "2Gi"
              cpu: "2000m"
          readinessProbe:
            exec:
              command:
                - pg_isready
                - -U
                - morph
                - -d
                - morphdb
            initialDelaySeconds: 15
            periodSeconds: 10
          livenessProbe:
            exec:
              command:
                - pg_isready
                - -U
                - morph
                - -d
                - morphdb
            initialDelaySeconds: 30
            periodSeconds: 15
      volumes:
        - name: data
          persistentVolumeClaim:
            claimName: citus-coordinator-pvc
        - name: config
          configMap:
            name: postgres-config
---
# Headless Service for Workers (enables DNS for each pod)
apiVersion: v1
kind: Service
metadata:
  name: citus-worker
  namespace: morph
  labels:
    app: citus-worker
spec:
  clusterIP: None
  ports:
    - port: 5432
      targetPort: 5432
      name: postgres
  selector:
    app: citus-worker
---
# Worker StatefulSet
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: citus-worker
  namespace: morph
  labels:
    app: citus-worker
spec:
  serviceName: citus-worker
  replicas: 3
  selector:
    matchLabels:
      app: citus-worker
  template:
    metadata:
      labels:
        app: citus-worker
        role: worker
    spec:
      containers:
        - name: worker
          image: citusdata/citus:12.1
          ports:
            - containerPort: 5432
          env:
            - name: POSTGRES_USER
              value: "morph"
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: postgres-secrets
                  key: password
            - name: POSTGRES_DB
              value: "morphdb"
            - name: PGDATA
              value: "/var/lib/postgresql/data/pgdata"
          volumeMounts:
            - name: data
              mountPath: /var/lib/postgresql/data
            - name: config
              mountPath: /etc/postgresql/postgresql.conf
              subPath: postgresql.conf
            - name: config
              mountPath: /etc/postgresql/pg_hba.conf
              subPath: pg_hba.conf
          resources:
            requests:
              memory: "256Mi"
              cpu: "250m"
            limits:
              memory: "1Gi"
              cpu: "1000m"
          readinessProbe:
            exec:
              command:
                - pg_isready
                - -U
                - morph
                - -d
                - morphdb
            initialDelaySeconds: 15
            periodSeconds: 10
          livenessProbe:
            exec:
              command:
                - pg_isready
                - -U
                - morph
                - -d
                - morphdb
            initialDelaySeconds: 30
            periodSeconds: 15
      volumes:
        - name: config
          configMap:
            name: postgres-config
  volumeClaimTemplates:
    - metadata:
        name: data
      spec:
        accessModes: ["ReadWriteOnce"]
        storageClassName: morph-storage
        resources:
          requests:
            storage: 5Gi
---
# Prometheus for monitoring
apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-config
  namespace: morph
data:
  prometheus.yml: |
    global:
      scrape_interval: 15s
      evaluation_interval: 15s
    
    scrape_configs:
      - job_name: 'prometheus'
        static_configs:
          - targets: ['localhost:9090']
      
      - job_name: 'postgres-exporter'
        static_configs:
          - targets: ['postgres-exporter:9187']
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: prometheus
  namespace: morph
spec:
  replicas: 1
  selector:
    matchLabels:
      app: prometheus
  template:
    metadata:
      labels:
        app: prometheus
    spec:
      containers:
        - name: prometheus
          image: prom/prometheus:v2.45.0
          ports:
            - containerPort: 9090
          volumeMounts:
            - name: config
              mountPath: /etc/prometheus/prometheus.yml
              subPath: prometheus.yml
          resources:
            requests:
              memory: "256Mi"
              cpu: "100m"
            limits:
              memory: "512Mi"
              cpu: "500m"
      volumes:
        - name: config
          configMap:
            name: prometheus-config
---
apiVersion: v1
kind: Service
metadata:
  name: prometheus
  namespace: morph
spec:
  type: NodePort
  ports:
    - port: 9090
      targetPort: 9090
      nodePort: 30090
  selector:
    app: prometheus
---
# PostgreSQL Exporter for Prometheus
apiVersion: apps/v1
kind: Deployment
metadata:
  name: postgres-exporter
  namespace: morph
spec:
  replicas: 1
  selector:
    matchLabels:
      app: postgres-exporter
  template:
    metadata:
      labels:
        app: postgres-exporter
    spec:
      containers:
        - name: exporter
          image: prometheuscommunity/postgres-exporter:v0.14.0
          ports:
            - containerPort: 9187
          env:
            - name: DATA_SOURCE_NAME
              value: "postgresql://morph:MorphSecurePass123!@citus-coordinator:5432/morphdb?sslmode=disable"
          resources:
            requests:
              memory: "64Mi"
              cpu: "50m"
            limits:
              memory: "128Mi"
              cpu: "200m"
---
apiVersion: v1
kind: Service
metadata:
  name: postgres-exporter
  namespace: morph
spec:
  ports:
    - port: 9187
      targetPort: 9187
  selector:
    app: postgres-exporter
